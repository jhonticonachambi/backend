# üìã MANUAL DE PRUEBAS - PostulationController UPDATE STATUS

## ‚öôÔ∏è COMO SE INSTALA Y CONFIGURA

### Instalaci√≥n de Dependencias:
```bash
npm install jest supertest mongoose
```

### Configuraci√≥n del Entorno:
```javascript
// Archivo: tests/controllers/postulationController.updatePostulationStatus.test.js
NODE_ENV=test
```

## üìä DATOS INGRESADOS

### Componente bajo Prueba:
- **Controlador**: `postulationController.js`
- **M√©todo espec√≠fico**: `updatePostulationStatus()`
- **Tipo**: Actualizaci√≥n de estado de postulaciones con notificaciones autom√°ticas

## üß™ PROCESO Y RESULTADO

### Pruebas Unitarias Ejecutadas:

#### üîç Caso 1: Actualizaci√≥n exitosa a "accepted" con notificaciones
**Datos de entrada espec√≠ficos (input):**
```javascript
req.body = {
  "ids": [
    "507f1f77bcf86cd799439011",
    "507f1f77bcf86cd799439012"
  ],
  "newStatus": "accepted"
}
```
### Archivo de Prueba:
```
üìÅ tests/controllers/postulationController.updatePostulationStatus.test.js
```


**Resultado esperado:**
```
Status: 200
Response: {
  message: "Postulations status updated successfully",
  postulaciones: [array de postulaciones actualizadas]
}
```

**Resultado real obtenido:**
```
üìã CASO 1: Actualizaci√≥n exitosa a "accepted"
üìä Input: {
  "ids": [
    "507f1f77bcf86cd799439011",
    "507f1f77bcf86cd799439012"
  ],
  "newStatus": "accepted"
}

‚úÖ M√©todo: updatePostulationStatus ‚Üí con m√∫ltiples IDs y status "accepted" ‚Üí resultado: postulaciones actualizadas y notificaciones creadas

‚úÖ Response Status: 200

‚úÖ Response JSON: {
  "message": "Postulations status updated successfully",
  "postulaciones": [
    {
      "_id": "507f1f77bcf86cd799439011",
      "userId": {
        "_id": "user123"
      },
      "projectId": "project456",
      "status": "accepted"
    },
    {
      "_id": "507f1f77bcf86cd799439012",
      "userId": {
        "_id": "user789"
      },
      "projectId": "project456",
      "status": "accepted"
    }
  ]
}
```

---

#### üîç Caso 2: Error 404 - Postulaciones no encontradas
**Datos de entrada espec√≠ficos (input):**
```javascript
req.body = {
  "ids": [
    "507f1f77bcf86cd799439020"
  ],
  "newStatus": "accepted"
}
```

**Resultado esperado:**
```
Status: 404
Response: {
  message: "Postulations not found"
}
```

**Resultado real obtenido:**
```
üìã CASO 2: Error 404 - Postulaciones no encontradas
üìä Input: {
  "ids": [
    "507f1f77bcf86cd799439020"
  ],
  "newStatus": "accepted"
}

‚ùå M√©todo: updatePostulationStatus ‚Üí con IDs inexistentes ‚Üí resultado: error 404 postulaciones no encontradas

‚úÖ Response Status: 404

‚úÖ Response JSON: {
  "message": "Postulations not found"
}
```

---

## üìÑ Estructura del Archivo de Prueba

### Archivo: `tests/controllers/postulationController.updatePostulationStatus.test.js`

```javascript
const { updatePostulationStatus } = require('../../controllers/postulationController');

// Mock de mongoose primero
jest.mock('mongoose', () => ({
  Schema: {
    Types: {
      ObjectId: jest.fn()
    }
  },
  model: jest.fn(),
  connect: jest.fn()
}));

// Mock de todas las dependencias ANTES de importar el controlador
jest.mock('../../models/Postulation', () => ({
  find: jest.fn(),
  findOne: jest.fn()
}));

jest.mock('../../models/Notification', () => jest.fn().mockImplementation(() => ({
  save: jest.fn()
})));

const Postulacion = require('../../models/Postulation');
const Notification = require('../../models/Notification');

describe('PostulationController - updatePostulationStatus', () => {
  let req, res;

  beforeEach(() => {
    // Configurar mocks de request y response
    req = {
      body: {}
    };

    res = {
      status: jest.fn().mockReturnThis(),
      json: jest.fn().mockReturnThis()
    };

    // Limpiar mocks
    jest.clearAllMocks();
  });

  describe('Casos de √©xito', () => {
    test('Debe actualizar status a "accepted" y crear notificaci√≥n correctamente', async () => {
      // Arrange
      const mockIds = ['507f1f77bcf86cd799439011', '507f1f77bcf86cd799439012'];
      const mockPostulations = [
        {
          _id: '507f1f77bcf86cd799439011',
          userId: { _id: 'user123' },
          projectId: 'project456',
          status: 'pending',
          save: jest.fn().mockResolvedValue()
        },
        {
          _id: '507f1f77bcf86cd799439012',
          userId: { _id: 'user789' },
          projectId: 'project456',
          status: 'pending',
          save: jest.fn().mockResolvedValue()
        }
      ];

      req.body = {
        ids: mockIds,
        newStatus: 'accepted'
      };

      Postulacion.find.mockResolvedValue(mockPostulations);
      Notification.mockImplementation(() => ({
        save: jest.fn().mockResolvedValue()
      }));

      // Act
      await updatePostulationStatus(req, res);

      // Assert
      console.log('=== CASO √âXITO - Status Accepted ===');
      console.log('Input:', JSON.stringify(req.body, null, 2));
      console.log('Response Status:', res.status.mock.calls[0][0]);
      console.log('Response JSON:', JSON.stringify(res.json.mock.calls[0][0], null, 2));
      console.log('===============================');
      
      expect(Postulacion.find).toHaveBeenCalledWith({ '_id': { $in: mockIds } });
      expect(mockPostulations[0].save).toHaveBeenCalled();
      expect(mockPostulations[1].save).toHaveBeenCalled();
      expect(mockPostulations[0].status).toBe('accepted');
      expect(mockPostulations[1].status).toBe('accepted');
      expect(Notification).toHaveBeenCalledTimes(2);
      expect(res.status).toHaveBeenCalledWith(200);
      expect(res.json).toHaveBeenCalledWith({
        message: 'Postulations status updated successfully',
        postulaciones: mockPostulations
      });
    });

    // ... otros tests de √©xito ...
  });

  describe('Casos de postulaciones no encontradas', () => {
    test('Debe retornar error 404 cuando no se encuentran postulaciones', async () => {
      // Arrange
      req.body = {
        ids: ['507f1f77bcf86cd799439020'],
        newStatus: 'accepted'
      };

      Postulacion.find.mockResolvedValue([]); // Array vac√≠o

      // Act
      await updatePostulationStatus(req, res);

      // Assert
      console.log('=== CASO ERROR 404 - Postulations Not Found ===');
      console.log('Input:', JSON.stringify(req.body, null, 2));
      console.log('Response Status:', res.status.mock.calls[0][0]);
      console.log('Response JSON:', JSON.stringify(res.json.mock.calls[0][0], null, 2));
      console.log('=========================================');
      
      expect(Postulacion.find).toHaveBeenCalledWith({ '_id': { $in: req.body.ids } });
      expect(res.status).toHaveBeenCalledWith(404);
      expect(res.json).toHaveBeenCalledWith({ message: 'Postulations not found' });
    });

    // ... otros tests de error 404 ...
  });

  // ... otros describe blocks con tests adicionales ...
});
```

### üîß Configuraci√≥n de Mocks

**Mongoose Mock:**
```javascript
jest.mock('mongoose', () => ({
  Schema: {
    Types: {
      ObjectId: jest.fn()
    }
  },
  model: jest.fn(),
  connect: jest.fn()
}));
```

**Postulation Model Mock:**
```javascript
jest.mock('../../models/Postulation', () => ({
  find: jest.fn(),
  findOne: jest.fn()
}));
```

**Notification Model Mock:**
```javascript
jest.mock('../../models/Notification', () => jest.fn().mockImplementation(() => ({
  save: jest.fn()
})));
```

### üìã Setup de Request/Response

```javascript
beforeEach(() => {
  req = {
    body: {}
  };

  res = {
    status: jest.fn().mockReturnThis(),
    json: jest.fn().mockReturnThis()
  };

  jest.clearAllMocks();
});
```

---

## Resultados de Ejecuci√≥n Completa

### Ejecuci√≥n Real del 8 de junio de 2025

```bash
npx jest tests/controllers/postulationController.updatePostulationStatus.test.js

Test Suites: 1 passed, 1 total
Tests:       17 passed, 17 total
Snapshots:   0 total
Time:        1.594 s
```

---


‚úÖ **Casos de √âxito (4 tests)**:
- Actualizaci√≥n a "accepted" con creaci√≥n de notificaciones
- Actualizaci√≥n a "rejected" sin notificaciones  
- Actualizaci√≥n a "pending" correctamente
- Manejo de postulaciones sin userId

‚úÖ **Validaci√≥n de Entrada (4 tests)**:
- Rechazo de estados inv√°lidos (error 400)
- Validaci√≥n de estados v√°lidos: pending, accepted, rejected

‚úÖ **Postulaciones No Encontradas (2 tests)**:
- Error 404 cuando no se encuentran postulaciones
- Manejo de IDs inexistentes

‚úÖ **Errores del Servidor (3 tests)**:
- Error 500 en consultas de BD
- Error 500 al guardar postulaciones
- Error 500 al crear notificaciones

‚úÖ **M√∫ltiples Postulaciones (2 tests)**:
- Procesamiento de postulaciones mixtas
- Arrays con una sola postulaci√≥n

‚úÖ **Verificaci√≥n MongoDB (2 tests)**:
- Consultas correctas con $in
- Bucles de procesamiento m√∫ltiple

---

## üöÄ Configuraci√≥n CI/CD (Integraci√≥n Continua)

### Scripts de Automatizaci√≥n en package.json:
```json
{
  "scripts": {
    "test": "jest",
    "test:postulation": "jest tests/controllers/postulationController.updatePostulationStatus.test.js",
    "test:postulation:watch": "jest tests/controllers/postulationController.updatePostulationStatus.test.js --watch",
    "test:postulation:coverage": "jest tests/controllers/postulationController.updatePostulationStatus.test.js --coverage"
  }
}
```

### Pipeline de GitHub Actions (.github/workflows/ci-tests.yml):
```yaml
name: üß™ Automated Tests CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run postulation controller tests
      run: npx jest tests/controllers/postulationController.updatePostulationStatus.test.js --coverage --verbose
```

### ‚úÖ Beneficios de CI/CD:
```
üöÄ Ejecuci√≥n autom√°tica: Las pruebas se ejecutan en cada push/PR
üîç M√∫ltiples versiones de Node: Probado en Node 16.x, 18.x, 20.x
üìä Cobertura autom√°tica: Genera reportes de cobertura de c√≥digo
üõ°Ô∏è Bloqueo de merge: No se puede hacer merge si fallan las pruebas
‚ö° Feedback inmediato: Resultados en menos de 2 minutos
üìà Historial completo: Registro de todas las ejecuciones de pruebas
```

---

**Autor**: Sistema de Pruebas Automatizadas  
**Fecha**: 8 de junio de 2025  
**Versi√≥n**: 1.0  
**Pr√≥xima Revisi√≥n**: Seg√∫n actualizaciones del controlador
